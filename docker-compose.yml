version: '3.8'

services:
  # Virtual Display Server (for screen automation)
  xvfb:
    image: jare/x11-bridge
    container_name: aviator-display
    environment:
      - DISPLAY=:99
      - SCREEN_RESOLUTION=1920x1080x24
    ports:
      - "5900:5900"  # VNC port for remote viewing
    networks:
      - aviator-network
    restart: unless-stopped

  # Aviator Dashboard Service
  dashboard:
    build:
      context: .
      dockerfile: Dockerfile.dashboard
    container_name: aviator-dashboard
    depends_on:
      - xvfb
    environment:
      - DISPLAY=:99
      - FLASK_ENV=production
      - FLASK_APP=run_dashboard.py
    ports:
      - "5001:5001"
    volumes:
      - ./backend:/app/backend
      - ./run_dashboard.py:/app/run_dashboard.py
      - aviator-data:/app/data
    networks:
      - aviator-network
    restart: unless-stopped
    command: python3 run_dashboard.py

  # Aviator Bot Service
  bot:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: aviator-bot
    depends_on:
      - dashboard
      - xvfb
    environment:
      - DISPLAY=:99
      - TESSERACT_PATH=/usr/bin/tesseract
      - BOT_MODE=${BOT_MODE:-dry_run}
      - INITIAL_STAKE=${INITIAL_STAKE:-25}
      - MAX_STAKE=${MAX_STAKE:-1000}
      - STAKE_INCREASE_PERCENT=${STAKE_INCREASE_PERCENT:-20}
    volumes:
      - ./backend:/app/backend
      - aviator-data:/app/data
      - /tmp/.X11-unix:/tmp/.X11-unix:rw
    networks:
      - aviator-network
    restart: unless-stopped
    # For interactive mode, use: docker-compose run bot
    # For auto mode with .env settings:
    command: python3 backend/bot.py --auto --mode ${BOT_MODE:-dry_run}

volumes:
  aviator-data:
    driver: local

networks:
  aviator-network:
    driver: bridge
